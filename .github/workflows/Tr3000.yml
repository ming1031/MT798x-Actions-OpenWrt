name: Build TR3000 128MB ImmortalWrt

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Which branch/tag to use from the upstream repo (optional). If missing or not found, the repo default branch will be used.'
        required: false
        default: 'openwrt-21.02'

env:
  REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
  BUILD_DIR: openwrt

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480
    steps:
      - name: Checkout this repo (contains Tr3000/.config)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git \
            libncurses-dev libssl-dev python3-distutils \
            rsync unzip zlib1g-dev file wget curl ca-certificates

      - name: Determine upstream branch to use
        id: choose_branch
        run: |
          REQUESTED="${{ github.event.inputs.branch }}"
          echo "requested=${REQUESTED}" > /tmp/branch.env
          # check if branch exists in remote
          if git ls-remote --heads "${{ env.REPO_URL }}" "${REQUESTED}" | grep -q refs/heads/"${REQUESTED}"; then
            echo "Using requested branch: ${REQUESTED}"
            echo "UPSTREAM_BRANCH=${REQUESTED}" >> $GITHUB_OUTPUT
          else
            echo "Requested branch '${REQUESTED}' not found on remote; will clone default branch instead."
            echo "UPSTREAM_BRANCH=" >> $GITHUB_OUTPUT
          fi

      - name: Clone ImmortalWrt source (branch-aware)
        run: |
          BR=${{ steps.choose_branch.outputs.UPSTREAM_BRANCH }}
          if [ -n "$BR" ]; then
            git clone --depth=1 -b "$BR" "${{ env.REPO_URL }}" "${{ env.BUILD_DIR }}"
          else
            git clone --depth=1 "${{ env.REPO_URL }}" "${{ env.BUILD_DIR }}"
          fi
          echo "Cloned into ${BUILD_DIR}:"
          ls -la ${BUILD_DIR} | sed -n '1,40p'

      - name: Copy TR3000 .config
        run: |
          if [ ! -f "Tr3000/.config" ]; then
            echo "Error: Tr3000/.config not found in repo root."
            ls -la
            exit 1
          fi
          cp Tr3000/.config ${{ env.BUILD_DIR }}/.config
          echo "Copied Tr3000/.config -> ${BUILD_DIR}/.config"

      - name: Update & install feeds
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate final config (defconfig)
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make defconfig

      - name: Download packages (cache-friendly)
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make download -j$(nproc) || true

      - name: Build firmware
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          make -j$(nproc) V=s

      - name: Collect firmware files
        run: |
          mkdir -p firmware
          # copy typical factory/sysupgrade artifacts if present
          shopt -s globstar || true
          cp -v ${BUILD_DIR}/bin/targets/**/**/*factory*.bin firmware/ 2>/dev/null || true
          cp -v ${BUILD_DIR}/bin/targets/**/**/*sysupgrade*.bin firmware/ 2>/dev/null || true
          cp -v ${BUILD_DIR}/bin/targets/**/**/openwrt-*sysupgrade*.bin firmware/ 2>/dev/null || true
          ls -lh firmware || true

      - name: Upload artifacts (build outputs)
        uses: actions/upload-artifact@v4
        with:
          name: TR3000-128MB-firmware
          path: firmware/*

      - name: Create Release Tag (timestamp)
        id: set_tag
        run: |
          TAG=TR3000-$(date -u +'%Y%m%d%H%M')
          echo "TAG=${TAG}" >> $GITHUB_OUTPUT

      - name: Publish Release & upload firmware
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.set_tag.outputs.TAG }}
          name: ${{ steps.set_tag.outputs.TAG }}
          body: "自动构建：${{ steps.set_tag.outputs.TAG }}"
          files: |
            firmware/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
